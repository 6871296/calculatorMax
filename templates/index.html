<!DOCTYPE html>
<html lang="zh">
    <head>
        <script src="/assets/api_waiter.js"></script>
        <meta charset="UTF-8">
        <title>首页 - calculatorMax</title>
        <link rel="stylesheet" href="/assets/style.css">
    </head>
    <body class="app-container">
        <noscript>
            <h1>啊哦 :(</h1>
            <p>
                JavaScript不支持
                <strong>可能的解决办法：</strong>
                <ul>
                    <li>升级PyWebview: <code>pip install --upgrade pywebview</code></li>
                    <li>联系开发者</li>
                </ul>
            </p>
        </noscript>
        <script>
            import { Fireworks } from 'https://esm.run/fireworks-js';

            const container = document.querySelector('html');

            const options = {
            gravity: 1.4,
            opacity: 0.4,
            autoresize: true,
            acceleration: 1.00,
            };

            let fireworks = new Fireworks(container, options);

            let resExists=false;
            let memoryValue = 0;
            let l14514=false
            const date=new Date()
            let isafd=date.getMonth()===4 && date.getDay()===1
            
            // 窗口状态追踪
            const windowState = {
                visible: !document.hidden,
                focused: document.hasFocus(),
                // 判断窗口是否完全被遮挡（不可见或失去焦点）
                isHidden() {
                    return !this.visible || !this.focused;
                }
            };
            
            // 监听窗口状态变化
            document.addEventListener('visibilitychange', () => {
                windowState.visible = !document.hidden;
                console.log('页面可见性:', windowState.visible ? '可见' : '隐藏');
            });
            
            window.addEventListener('focus', () => {
                windowState.focused = true;
                console.log('窗口焦点: 获得');
            });
            
            window.addEventListener('blur', () => {
                windowState.focused = false;
                console.log('窗口焦点: 失去');
            });
            
            // 请求通知权限
            function requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        console.log('通知权限:', permission);
                    });
                }
            }
            
            // 发送计算完成通知
            function sendCalcNotification(expression, result, isError) {
                if (!('Notification' in window)) {
                    console.log('浏览器不支持 Notification API');
                    return;
                }
                if (Notification.permission !== 'granted') {
                    console.log('没有通知权限');
                    return;
                }
                
                const title = isError ? '❌ 计算出错' : '✓ 计算完成';
                // 处理长文本
                const maxExprLen = 30;
                const maxResultLen = 50;
                const shortExpr = expression.length > maxExprLen 
                    ? expression.substring(0, maxExprLen) + '...' 
                    : expression;
                const shortResult = result.length > maxResultLen 
                    ? result.substring(0, maxResultLen) + '...' 
                    : result;
                
                const body = isError 
                    ? `算式: ${shortExpr}\n错误: ${shortResult}`
                    : `算式: ${shortExpr}\n结果: ${shortResult}`;
                
                try {
                    const notification = new Notification(title, {
                        body: body,
                        tag: 'calc-result-' + Date.now(),
                        requireInteraction: false,
                        silent: false
                    });
                    
                    // 点击通知时聚焦窗口
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    
                    console.log('已发送通知:', title);
                } catch (e) {
                    console.error('发送通知失败:', e);
                }
            }
            
            function status(b){
                if(b){
                    document.querySelector("h1").style.color="green";
                    setTimeout(function(){document.querySelector("h1").style.color="black";},1000);
                }
                else{
                    document.querySelector("h1").style.color="red";
                    setTimeout(function(){document.querySelector("h1").style.color="black";document.querySelector("h1").textContent='CalculatorMax'},1000);
                }
            }
            
            async function calc(){
                let expression = document.getElementById("ev-input").value;
                if(expression==='')return;
                let calc_res;
                
                // 确保有通知权限（首次点击计算时请求）
                requestNotificationPermission();
                
                try {
                    // 支持两种模式：pywebview 直接调用 和 HTTP API
                    if (window.pywebview && window.pywebview.api && window.pywebview.api.calc) {
                        let result = window.pywebview.api.calc(expression);
                        // 处理 Promise 或直接返回值
                        if (result && typeof result.then === 'function') {
                            calc_res = await result;
                        } else if (result && result.result !== undefined) {
                            calc_res = [result.result, result.error];
                        } else {
                            calc_res = result;
                        }
                    } else {
                        // HTTP 模式
                        let response = await fetch('/api/calc', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({expression: expression})
                        });
                        let data = await response.json();
                        calc_res = [data.result, data.error];
                    }
                    status(true)
                } catch (e) {
                    console.error(e);
                    calc_res = ['计算错误: ' + e.message, true];
                    status(false)
                }
                
                let res = calc_res[0];
                let err = calc_res[1];
                
                // 检查窗口是否被遮挡，如果是则发送通知
                if (windowState.isHidden()) {
                    sendCalcNotification(expression, res, err);
                }
                
                ac();
                if(err){
                    document.getElementById("res").style.display="inline";
                    document.getElementById("equal-sign").style.color="red";
                    document.getElementById("equal-sign").innerText="错误：";
                    document.getElementById("res-btns").style.display="none";
                    status(false);
                    document.getElementById("ev-result").innerText=res;
                }else{
                    resExists=true;
                    document.getElementById("res-btns").style.display="block";
                    document.getElementById("res").style.display="inline";
                    status(true);
                    // 显示结果并检查是否需要截断
                    displayResult(res);
                }
            }
            
            function updateInputBg(){
                var input = document.getElementById("ev-input");
                if(input.value === ""){
                    input.style.backgroundColor = "#00ffff44";
                }else{
                    input.style.backgroundColor = "#00ffff88";
                }
            }
            function onload(){
                var input = document.getElementById("ev-input");
                input.onkeydown=function(e){if(e.key=="Enter")calc();}
                input.oninput=updateInputBg;
                input.onfocus=function(){
                    input.select()
                    if(resExists)input.value=fullResultText
                    updateInputBg();
                };
                input.onblur=function(){
                    input.style.backgroundColor = "";
                };
                input.focus();
            }
            function displayResult(text) {
                const resultEl = document.getElementById("ev-result");
                const truncatedEl = document.getElementById("ev-result-truncated");
                const hintEl = document.getElementById("ev-result-hint");
                
                // 保存完整结果用于复制
                fullResultText = text;
                
                // 先设置完整文本
                resultEl.innerText = text;
                resultEl.classList.remove("truncated");
                truncatedEl.style.display = "none";
                hintEl.style.display = "none";
                
                // 使用 requestAnimationFrame 确保 DOM 已更新
                requestAnimationFrame(() => {
                    // 计算行数
                    const lineHeight = parseFloat(getComputedStyle(resultEl).lineHeight);
                    const height = resultEl.scrollHeight;
                    const lines = Math.round(height / lineHeight);
                    
                    if (lines > 5) {
                        // 超过5行，添加截断样式
                        resultEl.classList.add("truncated");
                        truncatedEl.style.display = "inline";
                        hintEl.style.display = "block";
                    }
                });
            }
            
            function ac(){
                resExists=false;
                document.getElementById("ev-input").value="";
                document.getElementById("res").style.display="none";
                document.getElementById("res-btns").style.display="none";
                document.getElementById("equal-sign").style.color="black";
                document.getElementById("equal-sign").innerText="=";
                // 重置结果显示
                document.getElementById("ev-result").innerText = "";
                document.getElementById("ev-result").classList.remove("truncated");
                document.getElementById("ev-result-truncated").style.display = "none";
                document.getElementById("ev-result-hint").style.display = "none";
            }
            // 存储完整结果用于复制
            let fullResultText = "";
            
            function copy_res(){
                if(!resExists || !navigator.clipboard){
                    document.getElementById("res-copy").innerText="复制失败！";
                    document.getElementById("res-copy").style.color="red";
                    status(false);
                }else{
                    navigator.clipboard.writeText(fullResultText);
                    document.getElementById("res-copy").innerText="已复制";
                    document.getElementById("res-copy").style.color="green";
                    status(true);
                }
                setTimeout(function(){
                    document.getElementById("res-copy").innerText="复制";
                    document.getElementById("res-copy").style.color="black";
                },1000);
            }
            
            function copy_full(){
                if(!resExists || !navigator.clipboard){
                    document.getElementById("res-copy").innerText="复制失败！";
                    document.getElementById("res-copy").style.color="red";
                    status(false);
                }else{
                    navigator.clipboard.writeText(document.getElementById("ev-input").value + " = " + fullResultText);
                    document.getElementById("res-copy").innerText="已复制完整算式";
                    document.getElementById("res-copy").style.color="green";
                    status(true);
                }
                setTimeout(function(){
                    document.getElementById("res-copy").innerText="复制";
                    document.getElementById("res-copy").style.color="black";
                },1000);
            }
            
            async function mem_res(){
                if(!resExists){
                    document.getElementById("res-copy").innerText="记忆失败！";
                    document.getElementById("res-copy").style.color="red";
                    status(false);
                }else{
                    let val = fullResultText;
                    // 直接存储字符串，不转换为 float（避免精度丢失）
                    memoryValue = val;
                    
                    // 同步到服务器（HTTP 模式）
                    try {
                        await fetch('/api/mem', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({value: val})  // 发送字符串
                        });
                    } catch(e) {
                        document.getElementById("res-copy").innerText="记忆失败";
                        document.getElementById("res-copy").style.color="red";
                        status(false)
                        console.error('Failed to sync memory:', e);
                    }
                    
                    document.getElementById("res-copy").innerText="已记忆";
                    document.getElementById("res-copy").style.color="green";
                    status(true);
                }
                setTimeout(function(){
                    document.getElementById("res-copy").innerText="记忆";
                    document.getElementById("res-copy").style.color="black";
                },1000);
            }
            function openDialog(id){
                document.getElementById(id).showModal()
            }

            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', onload);
        </script>
        <style>
        </style>
        <nav>
            <div class="navdiv-l">
                <a href="/" class="navbox">
                    <strong class="navitem">CalculatorMax</strong>
                </a>
                <a href="/about" class="navbox">
                    <span class="navitem">关于</span>
                </a>
                <a href="/settings" class="navbox">
                    <span class="navitem">设置</span>
                </a>
            </div>
            <div class="navdiv-r">
                <a href="https://github.com/6871296/calculatorMax" class="navbox">
                    <span class="navitem"><img src="https://github.githubassets.com/favicons/favicon.svg" class="github-icon"></span>
                </a>
            </div>
        </nav>
        <main class="mid">
            <h1>CalculatorMax</h1>
            <p class="mid">计算一切结果</p>
            <div class="mid white round margined">
                <div style="align-self:center;align-items:flex-start;">
                    <input type="text" id="ev-input" placeholder="请输入算式">
                    <button id="ev-calc" onclick="calc()">计算</button><br>
                    <span id="res" style="display:none;">
                        <span id="equal-sign">=</span>
                        <div id="ev-result-container">
                            <span id="ev-result"></span>
                            <span id="ev-result-truncated" style="display:none;">……</span>
                        </div>
                        <span id="ev-result-hint" style="display:none; font-size:12px; color:#666; margin-top:4px;">输出过长，请复制查看</span>
                    </span>
                </div>
                <div id="res-btns" style="display:none;">
                    <button id="res-copy" class="res-btn" onclick="copy_res()" ondblclick="copy_full()">复制</button>
                    <button id="res-mem" class="res-btn" onclick="mem_res()">记忆</button>
                </div>
                <div class="ctrl-center">
                    <div id="ctrl-btns">
                        <button id="ctrl-btn-mem" onclick="ctrlTab('mem')"></button>
                        <button id="ctrl-btn-history" onclick="ctrlTab('history')"></button>
                    </div>
                    <div id="ctrl">
                        <h3 id="ctrl-name"></h3>
                        <div class="ctrl-part" id="ctrl-mem">
                            
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </body>
</html>
